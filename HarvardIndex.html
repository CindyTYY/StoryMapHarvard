<!DOCTYPE html>
<html lang="en">
<head>
    <title>
        China's Most Generous -
        The Ash Center for Democratic Governance and Innovation
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--meta data for sharing links on Facebook-->
    <meta property="og:title" content="China's Most Generous 2016" />
    <meta property="og:url" content="https://rawgit.com/CindyTYY/StoryMapHarvard/master/HarvardIndex.html" />
    <meta property="og:description" content="The Ash Center for Democratic Governance and Innovation." />
    <meta property="og:image" content="img/screenshot.png" />

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
    <link rel="stylesheet" href="https://dc-js.github.io/dc.js/css/dc.min.css">

    <!--animation-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">

    <!--facebook and info icons-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">



    <link rel="stylesheet" type="text/css" href="dist/storymap.css">
    <!--add favicon for the web page-->
    <link rel="shortcut icon" href="img/iconimage.png.ico" type="image/x-icon">
    <style>
        .end-background-img {
            background: url(img/shanghai.jpg) no-repeat center center fixed;
        }
        #mag-chart {
            width:100%;
            margin: 0 auto;
        }
    </style>

    <!--add required libraries-->
    <script src="https://unpkg.com/leaflet@1.0.2/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdn.bootcss.com/chroma-js/1.3.3/chroma.min.js"></script>
    <script src="https://dc-js.github.io/dc.js/js/d3.js"></script>
    <script src="https://dc-js.github.io/dc.js/js/crossfilter.js"></script>
    <script src="https://dc-js.github.io/dc.js/js/dc.js"></script>

    <!--story map plugin-->
    <script src="dist/storymap.js"></script>


    <!-- mini globle map -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
    <script src="js/globeminimap.js"></script>

</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-6 col-md-4 main">

            <section data-scene="title">
                <video class="background-fullscreen-setting" playsinline autoplay muted loop>
                    <source src="img/frontvideo.mp4" type="video/mp4">
                </video>
                <div class= "background-fullscreen-setting text-center" >
                    <br/>
                    <h3 class="" style="color: #FFFFFF">CHINA'S MOST GENEROUS</h3>
                    <h3><small style="color: #FFFFFF" >The Ash Center for Democratic Governance and Innovation releases its inaugural list of<br/>
                        2016’s top 100 Chinese philanthropists</small></h3>
                </div>
            </section>

            <section data-scene="introduction">
                <h2>Philanthropy</h2>
                <p>The growth of new wealth is one of the most important, far-reaching, and captBoivating aspects of change in modern China. Traditions of benevolent societies, clan-based giving, temple association support, and voluntarism have long been present in Chinese society, and coexisted alongside state-affiliated social welfare institutions throughout its dynastic, Republican, and Communist periods. Rapid economic expansion over the past 35 years has resulted in a generation of highly concentrated wealth holders who are now grappling with familiar questions of any gilded age: How should I give back to my community? Which causes are the most in need? How can I create meaningful change and have a lasting impact? Chinese philanthropy has also begun to branch into international networks of giving. Global leaders in the sector such as Bill Gates and Warren Buffett have sought to recruit counterparts of the developing world into “The Giving Pledge” and other forms of phased planning that enables donors, still far from retirement, to shape their giving. The rise of this new cohort of philanthropists leads to compelling questions:</p>
                <iframe width="400" height="225" src="https://www.youtube.com/embed/awxXHpsJGEk" frameborder="0" allowfullscreen align="center"></iframe>
                <p>
                <ul style="list-style-type: circle">
                    <li>Who are these new Chinese donors?</li>
                    <li>Which causes are they supporting?</li>
                    <li>What is the geography of giving in China?</li>
                    <li>Through what vehicles do they mobilize such support?</li>
                </ul>
                </p>
            </section>

            <section data-scene="DonationOriginAmount">
                <h2>Initial Results</h2>
                <p>As a result, impoverished provinces with limited local resources fare quite poorly. Less-developed regions with considerable environmental, educational, welfare, cultural, health, and disaster relief needs such as Xinjiang, Ningxia, and Tibet receive a dramatically lower amount of donations in both absolute and relative terms. For example, only 0.01% of 2015 giving by our Top 100 donors goes to Tibet, and a mere 0.04% goes to Xinjiang.</p>
                <img src="img/result.png" class="img-responsive" alt="responsive image" alt-text="the result of 2015">
            </section>

            <section data-scene="Charts">
                <div class="dc-data-count"></div>
                <h4># of Provinces: Count by Donation Amount</h4>
                <div id="mag-chart"></div>
            </section>

            <section data-scene="night">
                <h2>Economy(City Light)</h2>
                <p>This image of Earth’s city lights was created with data from the Defense Meteorological Satellite Program (DMSP) Operational Linescan System (OLS). Originally designed to view clouds by moonlight, the OLS is also used to map the locations of permanent lights on the Earth’s surface.
                    The brightest areas of the Earth are the most urbanized, but not necessarily the most populated. </p>
                <p>“Artificial lighting is a excellent remote sensing observable and proxy for human activity,” says Chris Elvidge, who leads the Earth Observation Group at NOAA’s National Geophysical Data Center. Social scientists and demographers have used night lights to model the spatial distribution of economic activity, of constructed surfaces, and of populations. Planners and environmental groups have used maps of lights to select sites for astronomical observatories and to monitor human development around parks and wildlife refuges. Electric power companies, emergency managers, and news media turn to night lights to observe blackouts.</p>
            </section>

            <section data-scene="end">
                <div class= "end-background-img background-fullscreen-setting text-center" >
                    <br/>
                    <h3 class="" style="color: white">China's Most Generous</h3>
                    <h4><small style="color: white">Copyright © 2016 The President and Fellows of Harvard College <br/>
                        Contact us via email: <a href="mailto:chinagives@ash.harvard.edu">chinagives@ash.harvard.edu </a>
                    <br/>
                    79 John F. Kennedy Street | Cambridge, MA 02138
                    </small></h4>
                    
            </section>

        </div>
        <!--map div-->
        <div id="map" class="col-sm-6 col-md-8 sidebar"></div>
    </div>
    <!--add a scrolling down arrow-->
    <div class="animated zoomIn infinite glyphicon glyphicon-menu-down arrow-down" style="color: white"></div>
    <!--add a navigation bar-->
    <div class="navbar text-center"></div>

    <!--add a info model -->
    <div id="loading">
        <i class="animated zoomIn infinite glyphicon glyphicon-globe"></i>
    </div>

    <dl>
        <dt>
            <!--facebook icon-->
            <a class="fa fa-facebook-square btn" href="https://facebook.com/sharer.php?u=http://rawgit.com/CindyTYY/StoryMapHarvard/master/HarvardIndex.html" style="color:white" target="_blank"></a>
        </dt>
        <dt>
            <!--git icon-->
            <a class="fa fa-git-square btn" href="https://github.com/CindyTYY/StoryMapHarvard" style="top:40px;color:white" target="_blank"></a>
        </dt>
        <dt>
            <!--info icon-->
            <i class="fa fa-file-text-o btn" style="top:60px;color:white" data-toggle="modal" data-target="#info-modal"></i>
        </dt>
    </dl>

    <!--the info page-->
    <div class="modal fade" id="info-modal" role="dialog">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">About</h4>
                </div>
                <div class="modal-body">
                    <p>This is a web map of ChinaPhilanthropy 2016. It is mainly made as a demo for a course GEOG 371: Web Mapping provided by Oregon State University. The story map library is derived from the storymap plugin for leaflet at <a>http://atlefren.github.io/storymap/</a>, and its functionality relies on both leaflet and Boostrap.</p>
                    <p><b>storymap.js</b> | Released Date: 02/20/2017 | Version: 2.1 | MIT License </p>
                    <p><b>Author: Tian Yuanyuan</b> | College of Earth, Ocean, Atmospheric Science | Oregon State University </p>
                    <p>The context and data about Chinese philanthropy was from Harvard. All rights reserved.</p>
                    <p>The <a src="https://www.youtube.com/watch?v=b-4ALvVO6SA">background video</a> on the second page was from Youtube. </p>
                    <p>The favicon image was acquired from <a>http://www.udlcenter.org/advocacy/state/oregon.</a></p>
                    <p>This story map uses geospatial data from mapbox, Google Earth Engine, Microsoft Bing map, Open Street Maps and Oregon Explorer.</p>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- main javascript -->
<script type="text/javascript">

    /**
     * Created by jakob on 4/20/2017.
     */
    // Create Legend Contents in html format
    var ChinaBoundary_legend = '<i style="background: white; opacity: 1"></i><p><b>China</b></p>';

    var OriginAmount_legend='<p><b>ProvinceOrigin<br/>Amount(mil RMB)</b></p>'+
        '<i style="background:#feebe2;opacity:0.5"></i><p><b>0</b></p>'+
        '<i style="background:#fbb4b9;opacity:0.5"></i><p><b>1-49</b></p>'+
        '<i style="background:#f768a1;opacity:0.5"></i><p><b>50-499</b></p>'+
        '<i style="background:#c51b8a;opacity:0.5"></i><p><b>500-6999</b></p>'+
        '<i style="background:#7a0177;opacity:0.5"></i><p><b>7000+</b></p>';


    //////////////////////////////////////////////////////////////////////////
    // Scene 3: Choropleth
    // Set function for color ramp
    function setColor(DoOriAm){
        //Tenary operation: condition ? valueIfTrue : valueIfFalse
        // condition ? value1 : value2
        return  DoOriAm > 7000 ? '#7a0177' :
            DoOriAm > 600 ? '#c51b8a' :
                DoOriAm > 50 ? '#f768a1' :
                    DoOriAm >  1 ? '#fbb4b9':
                       '#feebe2';
    }
    // Set style function that sets fill color property equal to DoOriAm
    function style(feature) {
        return {
            fillColor: setColor(feature.properties.DoOriAm),
            fillOpacity: 0.5,
            weight: 1,
            opacity: 1,
            color: '#ffffff',
            dashArray: '4'
        };
    }





    // For each layer, the first variable is the layer, the second is the legend. The layer variable can be any kinds of layers that leaflet.js supports.
    // var layers = {
    //      'layer1': [layer1, legend1]
    //      'layer2': [layer2, legend2]
    //      ...
    // }

    var layers = {
        'Esri_WorldImagery' : [L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
        })],
        'CartoDB_DarkMatter' : [L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
            subdomains: 'abcd',
            maxZoom: 19
        })],
        'ChinaBoundary': [ L.geoJson.ajax('assets/ChinaBoundary0508.geojson',  {
            color: 'white',
            weight: 3,
            opacity: 0.7}),
            ChinaBoundary_legend
        ],
        'CartoDB_DarkMatterNoLabels' : [L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="http://cartodb.com/attributions">CartoDB</a>',
            subdomains: 'abcd',
            maxZoom: 19
        })],
        'OriginAmount': [ L.geoJson.ajax('assets/HarvardReduced.geojson',  {
            style: style,
            onEachFeature: function (feature, layer) {
                layer.bindTooltip(feature.properties.DoOri + "<br/>" + " Donation Amount(as origin): " + feature.properties.DoOriAm.toString() + " mil RMB", {className: 'feature-label', permanent: false, direction: 'center'});
            }
        }),
            OriginAmount_legend
        ],
        'NASAGIBS_ViirsEarthAtNight2012' : [L.tileLayer('http://map1.vis.earthdata.nasa.gov/wmts-webmerc/VIIRS_CityLights_2012/default/{time}/{tilematrixset}{maxZoom}/{z}/{y}/{x}.{format}', {
            attribution: 'Imagery provided by services from the Global Imagery Browse Services (GIBS), operated by the NASA/GSFC/Earth Science Data and Information System (<a href="https://earthdata.nasa.gov">ESDIS</a>) with funding provided by NASA/HQ.',
            bounds: [[-85.0511287776, -179.999999975], [85.0511287776, 179.999999975]],
            minZoom: 1,
            maxZoom: 8,
            format: 'jpg',
            time: '',
            tilematrixset: 'GoogleMapsCompatible_Level',
            opacity: 0.9
        })]

    };


    var scenes = {
        title: {lat: 44, lng: -123.5, zoom: 7, position: 'fullpage', name: 'Cover Page'},
        introduction: {lat: 40, lng: 80, zoom: 4, name: 'Introduction', layers: ['CartoDB_DarkMatter','ChinaBoundary']},
        DonationOriginAmount: {lat: 40, lng: 80, zoom: 4, name: 'DonationOriginAmount', layers: ['CartoDB_DarkMatterNoLabels','OriginAmount','ChinaBoundary']},
        Charts: {lat: 40, lng: 80, zoom: 4, name: 'Charts', layers: ['CartoDB_DarkMatterNoLabels','OriginAmount','ChinaBoundary']},
        night: {lat: 40, lng: 80, zoom: 4, name: 'Night', layers: ['NASAGIBS_ViirsEarthAtNight2012','ChinaBoundary']},
        end: {lat: 44, lng: -123.5, zoom: 7, name: 'The End', position: 'fullpage'}
    };

    $('.main').storymap({
        scenes: scenes,
        layers: layers,
        legend: true, // if you do not want a legend feature, you can simply not define the createLegend function.
        scale: false,
        navbar: true,



        createMap: function () {
            // create a map in the "map" div, set the view to a given place and zoom
            var map = L.map('map', {zoomControl: false, scrollWheelZoom: true});

            // you can add an base map here which will be added to every scene, which can be either OSM, mapbox, tilelayer, wmslayer or those designed by yourself.

            // create a mini globe as the overview map control.
            var miniMap = new L.Control.GlobeMiniMap({
                position: 'bottomright'
            }).addTo(map);

            // hidden the credits, but show in the about page.
            $(".leaflet-control-attribution").css("display", "none");

            return map;
        }
    });

    ///////////////////图表
    d3.json('assets/Harvard0508.geojson', function(data) {
        //create crossfilter and filter all the data.
        var filter = crossfilter(data.features); //Create a crossfilter, input all the geospatial data.
        var all = filter.groupAll();  // study some of the key functions of crossfilter, such as groupAll, dimension
        var everything = filter.dimension(function(d) {
            return d
        });

        var geomDimension = filter.dimension(function(d) {
            return d.geometry
        });

        var magDimension = filter.dimension(function(d) {
            var mag = d.properties.DoOriAm;
            return  mag < 0.00000000000001 ? '0' :
                mag < 1 ? '1-50' :
                    mag < 50 ? '50-600' :
                        mag < 600 ? '600-7000' :
                            mag < 7000 ? '2.5-3' :
                                '>7000'
        });

        var magDimensionGroup = magDimension.group();

        //add the data to the map 删去此部分,动不了

        //create charts
        var magChart = dc.barChart('#mag-chart');

        magChart
            .height(180)
            .margins({top: 10, right: 50, bottom: 30, left: 40})
            .dimension(magDimension)
            .group(magDimensionGroup)
            .elasticY(true)
            .x(d3.scale.ordinal())
            .xUnits(dc.units.ordinal)
            .yAxis()
            .ticks(3);

        var earthquakeCount = dc.dataCount('.dc-data-count');
        earthquakeCount
            .dimension(filter)
            .group(all)
            .html({
                some: '<strong>%filter-count</strong> selected out of <strong>%total-count</strong> provinces' +
                ' | <a href=\'javascript:dc.filterAll(); dc.renderAll();\'>Reset All</a>',
                all: 'All provinces    selected. Please click on the graph or change the map view to apply filters.'
            });

        dc.renderAll();

        //chart listeners

        magChart.on('filtered', function(chart, filter) {
            updateMap()
        });


        function updateMap() {
            geoJsonLayer.clearLayers();
            geoJsonLayer.addData({
                type: 'FeatureCollection',
                features: everything.top(Infinity)
            });
        }

        //map listeners
        map.on('moveend', function() {
            updateMapFilter()
        });

        map.on('zoomend', function() {
            updateMapFilter()
        });

        function updateMapFilter() {

            geomDimension.filter(function(d) {
                return map.getBounds().contains(L.geoJSON(d).getBounds())
            });
            dc.redrawAll();
        }

    })






</script>
</body>
</html>
